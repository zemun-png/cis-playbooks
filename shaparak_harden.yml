- hosts: 10.10.10.100
  remote_user: root
  become: true
  become_method: sudo
  gather_facts: no

  vars:
    privileged_bins:
      - /usr/bin/write
      - /usr/bin/ksu
      - /usr/libexec/utempter/utempter
      - /usr/libexec/openssh/ssh-keysign
      - /usr/libexec/sssd/krb5_child
      - /usr/libexec/sssd/ldap_child
      - /usr/libexec/sssd/proxy_child
      - /usr/libexec/sssd/selinux_child

  tasks:

  # =========================
  # Kernel Module Hardening
  # =========================
    - name: Harden kernel modules
      tags: kernel_hardening
      block:
        - name: Disable unwanted filesystem modules
          copy:
            dest: "/etc/modprobe.d/{{ item }}.conf"
            content: |
              install {{ item }} /bin/false
              blacklist {{ item }}
            owner: root
            group: root
            mode: '0644'
          loop:
            - cramfs
            - squashfs
            - udf
            - usb-storage
            - hfs

        - name: Check if unwanted modules are loaded
          shell: |
            for mod in cramfs squashfs udf usb_storage hfs; do
              if lsmod | grep -q $mod; then
                echo "$mod"
              fi
            done
          register: loaded_modules
          changed_when: false
          ignore_errors: yes

        - name: Remove unwanted modules if loaded
          shell: |
            for mod in {{ loaded_modules.stdout_lines | default([]) }}; do
              modprobe -r $mod 2>/dev/null || true
            done
          args:
            warn: false
          when: loaded_modules.stdout != ""
          ignore_errors: yes

  # =========================
  # Kernel Sysctl Settings
  # =========================
    - name: Check current sysctl configuration
      shell: |
        sysctl -n kernel.randomize_va_space 2>/dev/null || echo "not_set"
        sysctl -n kernel.yama.ptrace_scope 2>/dev/null || echo "not_set"
      register: current_sysctl
      changed_when: false
      tags: sysctl_hardening

    - name: Apply kernel sysctl settings only if needed
      tags: sysctl_hardening
      copy:
        dest: /etc/sysctl.d/99-security-hardening.conf
        content: |
          # Memory and process security
          kernel.randomize_va_space = 2
          kernel.yama.ptrace_scope = 1
          fs.suid_dumpable = 0
          kernel.core_pattern=/dev/null
          
          # Network security IPv4
          net.ipv4.ip_forward = 0
          net.ipv4.tcp_syncookies = 1
          net.ipv4.conf.all.rp_filter = 1
          net.ipv4.conf.default.rp_filter = 1
          net.ipv4.tcp_fin_timeout = 30
          net.ipv4.conf.all.accept_redirects = 0
          net.ipv4.conf.default.accept_redirects = 0
          net.ipv4.conf.all.send_redirects = 0
          net.ipv4.conf.default.send_redirects = 0
          net.ipv4.conf.all.accept_source_route = 0
          net.ipv4.conf.default.accept_source_route = 0
          net.ipv4.conf.all.secure_redirects = 0
          net.ipv4.conf.all.log_martians = 1
          net.ipv4.icmp_echo_ignore_broadcasts = 1
          net.ipv4.icmp_ignore_bogus_error_responses = 1
          
          # Network security IPv6
          net.ipv6.conf.all.disable_ipv6 = 1
          net.ipv6.conf.default.disable_ipv6 = 1
          net.ipv6.conf.lo.disable_ipv6 = 1
          net.ipv6.conf.all.accept_redirects = 0
          net.ipv6.conf.default.accept_redirects = 0
          net.ipv6.conf.all.accept_ra=0
        owner: root
        group: root
        mode: '0644'
      register: sysctl_file
      when: 
        - current_sysctl.stdout_lines[0] != "2" or 
          current_sysctl.stdout_lines[1] != "1"

    - name: Apply sysctl settings if file created
      command: sysctl -p /etc/sysctl.d/99-security-hardening.conf
      when: sysctl_file.changed
      ignore_errors: yes
      tags: sysctl_hardening

  # =========================
  # Systemd & Coredump
  # =========================
    - name: Configure systemd coredump
      tags: systemd_hardening
      block:
        - name: Check current coredump config
          shell: |
            grep -E "^(Storage|ProcessSizeMax)=" /etc/systemd/coredump.conf || echo "not configured"
          args:
            warn: false
          register: coredump_current
          changed_when: false
          ignore_errors: yes

        - name: Configure coredump
          copy:
            dest: /etc/systemd/coredump.conf
            content: |
              [Coredump]
              Storage=none
              ProcessSizeMax=0
            owner: root
            group: root
            mode: '0644'
          when: "'Storage=none' not in coredump_current.stdout"
          register: coredump_file

        - name: Check coredump socket status
          shell: systemctl is-enabled systemd-coredump.socket 2>/dev/null || echo "not-found"
          register: coredump_socket_status
          changed_when: false

        - name: Disable coredump socket if enabled
          systemd:
            name: systemd-coredump.socket
            enabled: no
            state: stopped
          when: coredump_socket_status.stdout == "enabled"
          register: coredump_socket

        - name: Reload systemd configuration if changes made
          command: systemctl daemon-reexec
          when: coredump_file.changed or coredump_socket.changed
          ignore_errors: yes

  # =========================
  # Cron Security
  # =========================
    - name: Create missing cron files if they don't exist
      file:
        path: "{{ item }}"
        state: touch
        owner: root
        group: root
        mode: '0600'
      loop:
        - /etc/cron.allow
        - /etc/at.allow
      ignore_errors: yes
      tags: cron_hardening

    - name: Secure cron files with correct permissions
      file:
        path: "{{ item.path }}"
        owner: root
        group: root
        mode: "{{ item.mode }}"
      loop:
        - { path: '/etc/cron.allow',   mode: '0600' }
        - { path: '/etc/cron.d',       mode: '0700' }
        - { path: '/etc/cron.daily',   mode: '0700' }
        - { path: '/etc/cron.deny',    mode: '0600' }
        - { path: '/etc/cron.hourly',  mode: '0700' }
        - { path: '/etc/cron.monthly', mode: '0700' }
        - { path: '/etc/cron.weekly',  mode: '0700' }
        - { path: '/etc/crontab',      mode: '0600' }
        - { path: '/etc/at.allow',     mode: '0600' }
      ignore_errors: yes
      tags: cron_hardening

  # =========================
  # SSH Hardening
  # =========================
    - name: Harden SSH
      tags: ssh_hardening
      block:
        - name: Configure banners
          block:
            - name: Configure local banner
              copy:
                dest: /etc/issue
                content: |
                  ################################################################
                  # Welcome to SEP.co
                  # All Connections are monitored and recorded
                  # Disconnect IMMEDIATELY if you are not an authorized user!
                  ################################################################
                owner: root
                group: root
                mode: '0644'

            - name: Configure network banner
              copy:
                dest: /etc/issue.net
                content: |
                  ################################################################
                  # Welcome to SEP.co
                  # All Connections are monitored and recorded
                  # Disconnect IMMEDIATELY if you are not an authorized user!
                  ################################################################
                owner: root
                group: root
                mode: '0644'

        - name: Check current SSH hardening settings
          shell: |
            grep -E "^(LogLevel|Protocol|LoginGraceTime|MaxAuthTries|ClientAliveInterval|ClientAliveCountMax|GSSAPIAuthentication|AllowTcpForwarding|X11Forwarding|MaxStartups|Banner|Ciphers|MACs|KexAlgorithms)" /etc/ssh/sshd_config || echo "no settings"
          args:
            warn: false
          register: ssh_current
          changed_when: false
          ignore_errors: yes

        - name: Apply SSH hardening settings
          blockinfile:
            path: /etc/ssh/sshd_config
            block: |
              # Security Hardening Settings
              LogLevel INFO
              Protocol 2
              LoginGraceTime 60
              MaxAuthTries 4
              ClientAliveInterval 600
              ClientAliveCountMax 0
              GSSAPIAuthentication no
              AllowTcpForwarding no
              X11Forwarding no
              MaxStartups 10:30:60
              Banner /etc/issue
              Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes256-ctr
              MACs hmac-sha2-512,hmac-sha2-256
              KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group-exchange-sha256
            marker: "# {mark} ANSIBLE MANAGED BLOCK - SSH HARDENING"
            backup: yes
          when: "'GSSAPIAuthentication no' not in ssh_current.stdout"
          notify: Restart SSH

        - name: Check if semanage is available
          command: which semanage
          register: semanage_check
          changed_when: false
          ignore_errors: yes

  # =========================
  # Password Policy
  # =========================
    - name: Configure password policy
      tags: password_policy
      block:
        - name: Check current password policy
          command: grep -E "^(PASS_MAX_DAYS|PASS_MIN_DAYS|PASS_WARN_AGE|ENCRYPT_METHOD|INACTIVE)" /etc/login.defs
          register: login_defs_current
          changed_when: false
          ignore_errors: yes

        - name: Update login.defs
          lineinfile:
            path: /etc/login.defs
            regexp: "{{ item.regexp }}"
            line: "{{ item.line }}"
            backup: yes
          loop:
            - { regexp: '^PASS_MAX_DAYS', line: 'PASS_MAX_DAYS   365' }
            - { regexp: '^PASS_MIN_DAYS', line: 'PASS_MIN_DAYS   1' }
            - { regexp: '^PASS_WARN_AGE', line: 'PASS_WARN_AGE   7' }
            - { regexp: '^ENCRYPT_METHOD', line: 'ENCRYPT_METHOD SHA512' }
            - { regexp: '^INACTIVE', line: 'INACTIVE 45' }
          when: "item.line not in login_defs_current.stdout"

  # =========================
  # Sudoers Hardening - OPTIMIZED VERSION
  # =========================
    - name: Harden sudoers
      tags: sudo_hardening
      block:
        - name: Backup /etc/sudoers
          copy:
            src: /etc/sudoers
            dest: "/etc/sudoers.bak_{{ lookup('pipe','date +%F_%H%M%S') }}"
            remote_src: yes
          ignore_errors: yes

        - name: Apply CIS-approved sudoers defaults
          lineinfile:
            path: /etc/sudoers
            regexp: '^{{ item.regexp }}'
            line: '{{ item.line }}'
            state: present
            backup: yes
            validate: '/usr/sbin/visudo -cf %s'
          loop:
            - { regexp: 'Defaults\\s+use_pty', line: 'Defaults use_pty' }
            - { regexp: 'Defaults\\s+timestamp_timeout', line: 'Defaults timestamp_timeout=0' }
            - { regexp: 'Defaults\\s+log_output', line: 'Defaults log_output' }
            - { regexp: 'Defaults\\s+logfile=', line: 'Defaults logfile="/var/log/sudo.log"' }

        - name: Ensure single LINUXADMINS entry
          lineinfile:
            path: /etc/sudoers
            line: '%LINUXADMINS ALL=(ALL) ALL'
            state: present
            insertafter: '^## Read drop-in files from /etc/sudoers.d'
            validate: '/usr/sbin/visudo -cf %s'
          ignore_errors: yes

        - name: Display final sudoers settings
          shell: |
            grep -E "^(%LINUXADMINS|Defaults (use_pty|timestamp_timeout|log_output|logfile))" /etc/sudoers
          args:
            warn: false
          register: sudoers_final
          ignore_errors: yes

        - name: Debug final sudoers settings
          debug:
            var: sudoers_final.stdout

  # =========================
  # Filesystem Hardening
  # =========================
    - name: Check current /tmp permissions
      command: stat -c "%a" /tmp
      register: tmp_permissions
      changed_when: false
      ignore_errors: yes

    - name: Set sticky bit on /tmp
      file:
        path: /tmp
        mode: '1777'
      when: tmp_permissions.stdout != "1777"
      tags: fs_hardening

    - name: Check for world-writable files
      shell: |
        find / -xdev -type f -perm -0002 | head -10 | wc -l
      register: world_writable_count
      changed_when: false
      ignore_errors: yes

    - name: Fix world-writable files
      tags: fs_hardening
      shell: |
        find / -xdev -type f -perm -0002 -exec chmod o-w {} \;
        find / -xdev -type d -perm -0002 ! -perm -1000 -exec chmod +t {} \;
      args:
        warn: false
      when: world_writable_count.stdout != "0"
      ignore_errors: yes

# =========================
# Journald Hardening (Detailed)
# =========================
    - name: Harden systemd-journald
      tags: log_hardening
      block:
        # Task for 6.2.1.2 - journald log file access
        - name: Backup original journald tmpfiles config
          copy:
            src: /usr/lib/tmpfiles.d/systemd.conf
            dest: /usr/lib/tmpfiles.d/systemd.conf.bak
            remote_src: yes
          ignore_errors: yes
          when: '"systemd.conf" in lookup("fileglob", "/usr/lib/tmpfiles.d/*")'

        - name: Ensure correct permissions in systemd tmpfiles config
          blockinfile:
            path: /usr/lib/tmpfiles.d/systemd.conf
            block: |
              # Set proper permissions for journal directory
              d /var/log/journal 2755 root systemd-journal - -
              z /var/log/journal 2755 root systemd-journal - -
            marker: "# {mark} ANSIBLE MANAGED BLOCK - JOURNAL PERMISSIONS"
            backup: yes
          register: journald_tmpfile_fix

        - name: Apply tmpfiles configuration
          command: systemd-tmpfiles --create
          when: journald_tmpfile_fix.changed
          ignore_errors: yes

        # Task for 6.2.1.3 - journald log rotation
        - name: Backup original journald.conf
          copy:
            src: /etc/systemd/journald.conf
            dest: /etc/systemd/journald.conf.bak
            remote_src: yes
          ignore_errors: yes

        - name: Configure journald log rotation limits
          lineinfile:
            path: /etc/systemd/journald.conf
            regexp: '^{{ item.regexp }}'
            line: '{{ item.line }}'
            backup: yes
          loop:
            - { regexp: '^#?SystemMaxUse=', line: 'SystemMaxUse=500M' }
            - { regexp: '^#?SystemKeepFree=', line: 'SystemKeepFree=100M' }
            - { regexp: '^#?RuntimeMaxUse=', line: 'RuntimeMaxUse=100M' }
            - { regexp: '^#?RuntimeKeepFree=', line: 'RuntimeKeepFree=50M' }
            - { regexp: '^#?MaxFileSec=', line: 'MaxFileSec=1week' }
          register: journald_rotation_fix

        - name: Enable persistent storage for journal
          lineinfile:
            path: /etc/systemd/journald.conf
            regexp: '^#?Storage='
            line: 'Storage=persistent'
            backup: yes

        - name: Enable journal compression
          lineinfile:
            path: /etc/systemd/journald.conf
            regexp: '^#?Compress='
            line: 'Compress=yes'
            backup: yes

        - name: Set maximum retention period
          lineinfile:
            path: /etc/systemd/journald.conf
            regexp: '^#?MaxRetentionSec='
            line: 'MaxRetentionSec=1month'
            backup: yes

        - name: Restart systemd-journald service
          systemd:
            name: systemd-journald
            state: restarted
            daemon_reload: yes
          when: journald_tmpfile_fix.changed or journald_rotation_fix.changed

        - name: Verify journal configuration
          shell: |
            echo "=== Journal Configuration ==="
            sudo journalctl --verify
            
            echo -e "\n=== Journal Disk Usage ==="
            sudo journalctl --disk-usage
            
            echo -e "\n=== Journal Settings ==="
            sudo systemctl show systemd-journald | grep -E "(LogLevel|LogTarget|Storage|SystemMaxUse|RuntimeMaxUse)"
            
            echo -e "\n=== Journal Directory ==="
            ls -la /var/log/journal/ 2>/dev/null || echo "No persistent journal directory"
          register: journal_verification
          changed_when: false
          
        - name: Display journal hardening results
          debug:
            msg: |
              Journald Hardening Applied:
              - Tmpfiles config modified: {{ journald_tmpfile_fix.changed | default(false) }}
              - Rotation settings modified: {{ journald_rotation_fix.changed | default(false) }}
              - Verification output:
              {{ journal_verification.stdout }}

  # =========================
  # Auditd & AIDE
  # =========================
    - name: Configure AIDE & audit rules
      tags: audit_hardening
      block:
        - name: Check if AIDE database exists
          stat:
            path: /var/lib/aide/aide.db.gz
          register: aide_database
          changed_when: false

        - name: Initialize AIDE database
          command: aide --init
          args:
            creates: /var/lib/aide/aide.db.gz
          when: not aide_database.stat.exists
          ignore_errors: yes

        - name: Check if audit rules exist
          stat:
            path: /etc/audit/rules.d/hardening.rules
          register: audit_rules
          changed_when: false

        - name: Deploy auditd rules
          copy:
            dest: /etc/audit/rules.d/hardening.rules
            owner: root
            group: root
            mode: '0600'
            content: |
              ## Delete all existing rules
              -D
              -b 8192
              -f 1
              -a always,exit -F arch=b64 -S chmod -S fchmod -S fchmodat -F auid>=1000 -F auid!=4294967295 -k perm_mod
              -a always,exit -F arch=b32 -S chmod -S fchmod -S fchmodat -F auid>=1000 -F auid!=4294967295 -k perm_mod
              -a always,exit -F arch=b64 -S chown -S fchown -S fchownat -S lchown -F auid>=1000 -F auid!=4294967295 -k perm_mod
              -a always,exit -F arch=b32 -S chown -S fchown -S fchownat -S lchown -F auid>=1000 -F auid!=4294967295 -k perm_mod
              -a always,exit -F arch=b64 -S setxattr -S lsetxattr -S fsetxattr -S removexattr -S lremovexattr -S fremovexattr -F auid>=1000 -F auid!=4294967295 -k perm_mod
              -a always,exit -F arch=b32 -S setxattr -S lsetxattr -S fsetxattr -S removexattr -S lremovexattr -S fremovexattr -F auid>=1000 -F auid!=4294967295 -k perm_mod
              -w /usr/bin/docker -k docker
              -w /var/lib/docker -k docker
              -w /etc/docker -k docker
              -w /usr/lib/systemd/system/docker.service -k docker
              -w /usr/lib/systemd/system/docker.socket -k docker
              -w /etc/default/docker -k docker
              -w /etc/docker/daemon.json -k docker
              -w /usr/bin/docker-containerd -k docker
              -w /usr/bin/docker-runc -k docker
              -w /etc/nsswitch.conf -p wa -k nsswitch_changes
              -w /etc/security/ -p wa -k sec_changes
              -w /etc/selinux/ -p wa -k MAC-policy
              -w /usr/share/selinux/ -p wa -k MAC-policy
              -a always,exit -F arch=b64 -S adjtimex -S settimeofday -k time-change
              -a always,exit -F arch=b32 -S adjtimex -S settimeofday -S stime -k time-change
              -a always,exit -F arch=b64 -S clock_settime -k time-change
              -a always,exit -F arch=b32 -S clock_settime -k time-change
              -w /etc/localtime -p wa -k time-change
              -a always,exit -F arch=b64 -S sethostname -S setdomainname -k system-locale
              -a always,exit -F arch=b32 -S sethostname -S setdomainname -k system-locale
              -w /etc/issue -p wa -k system-locale
              -w /etc/issue.net -p wa -k system-locale
              -w /etc/hosts -p wa -k system-locale
              -w /etc/sysconfig/network -p wa -k system-locale
              -w /var/run/utmp -p wa -k session
              -w /var/log/wtmp -p wa -k logins
              -w /var/log/btmp -p wa -k logins
              -w /etc/sudoers -p wa -k scope
              -w /etc/sudoers.d/ -p wa -k scope
              -w /sbin/insmod -p x -k modules
              -w /sbin/rmmod -p x -k modules
              -w /sbin/modprobe -p x -k modules
              -a always,exit -F arch=b64 -S init_module -S delete_module -k modules
              -w /etc/group -p wa -k identity
              -w /etc/passwd -p wa -k identity
              -w /etc/gshadow -p wa -k identity
              -w /etc/shadow -p wa -k identity
              -w /etc/security/opasswd -p wa -k identity
              -a always,exit -F arch=b64 -S unlink -S unlinkat -S rename -S renameat -F auid>=1000 -F auid!=4294967295 -k delete
              -a always,exit -F arch=b32 -S unlink -S unlinkat -S rename -S renameat -F auid>=1000 -F auid!=4294967295 -k delete
              -a always,exit -F arch=b64 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access
              -a always,exit -F arch=b32 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access
              -a always,exit -F arch=b64 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access
              -a always,exit -F arch=b32 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access
              -a always,exit -F arch=b64 -S mount -F auid>=1000 -F auid!=4294967295 -k mounts
              -a always,exit -F arch=b32 -S mount -F auid>=1000 -F auid!=4294967295 -k mounts
              -e 2
          when: not audit_rules.stat.exists
          notify: Restart auditd
  # =========================
  # Firewall DROP Zone Configuration
  # =========================
    - name: Configure firewalld with DROP target
      tags: firewall_hardening
      block:
        - name: Check current firewall zone target
          shell: |
            # Check if public zone exists and get its target
            if firewall-cmd --get-zones | grep -q public; then
              firewall-cmd --permanent --zone=public --get-target
            else
              echo "not_found"
            fi
          register: current_zone_target
          changed_when: false
          ignore_errors: yes

        - name: Display current target
          debug:
            msg: "Current firewall zone target: {{ current_zone_target.stdout }}"

        - name: Set DROP target for public zone if not already set
          shell: |
            # Set target to DROP
            firewall-cmd --permanent --zone=public --set-target=DROP
            
            # Reload to apply changes
            firewall-cmd --reload
            
            # Verify the change
            firewall-cmd --permanent --zone=public --get-target
          when: current_zone_target.stdout != "DROP"
          args:
            warn: false
          register: set_drop_result
          ignore_errors: yes

        - name: Verify DROP target is applied
          shell: |
            echo "Running config: $(firewall-cmd --zone=public --get-target)"
            echo "Permanent config: $(firewall-cmd --permanent --zone=public --get-target)"
          register: verify_drop
          changed_when: false
          
        - name: Display final firewall configuration
          debug:
            msg: |
              Firewall DROP configuration status:
              - Running target: {{ verify_drop.stdout_lines[0] }}
              - Permanent target: {{ verify_drop.stdout_lines[1] }}
              - Changes made: {{ set_drop_result.changed | default(false) }}

  # =========================
  # Firewall Configuration
  # =========================
    - name: Configure firewalld with DROP policy
      tags: firewall_hardening
      block:
        - name: Check current firewalld zone
          command: firewall-cmd --list-all
          register: firewall_current
          changed_when: false
          ignore_errors: yes

        - name: Configure loopback interface properly (IPv4 and IPv6)
          shell: |
            # Allow legitimate loopback traffic in trusted zone (IPv4)
            firewall-cmd --permanent --zone=trusted --add-source=127.0.0.1/8 2>/dev/null || true
            
            # Allow legitimate loopback traffic in trusted zone (IPv6)
            firewall-cmd --permanent --zone=trusted --add-source=::1 2>/dev/null || true
            
            # Add loopback interface to trusted zone
            firewall-cmd --permanent --zone=trusted --add-interface=lo 2>/dev/null || true
            
            # Drop spoofed loopback packets in public zone (IPv4)
            firewall-cmd --permanent --zone=public --add-rich-rule='rule family=ipv4 source address=127.0.0.0/8 drop' 2>/dev/null || true
            
            # Drop spoofed loopback packets in public zone (IPv6)
            firewall-cmd --permanent --zone=public --add-rich-rule='rule family=ipv6 source address="::1" drop' 2>/dev/null || true
            
            firewall-cmd --reload
          args:
            warn: false
          ignore_errors: yes
          register: loopback_config

        - name: Unmask firewalld service
          systemd:
            name: firewalld
            masked: no
          when: "'masked' in firewall_current.stdout"

        - name: Enable and start firewalld
          systemd:
            name: firewalld
            enabled: yes
            state: started
          when: "'dead' in firewall_current.stdout"

        - name: Configure ICMP blocking
          shell: |
            firewall-cmd --permanent --add-icmp-block-inversion
            firewall-cmd --permanent --add-icmp-block=echo-reply
            firewall-cmd --permanent --add-icmp-block=echo-request
            firewall-cmd --reload
          args:
            warn: false
          when: "'icmp-block-inversion: no' in firewall_current.stdout"
          ignore_errors: yes

        - name: Verify loopback rules
          shell: |
            echo "=== IPv4 Loopback Rules ==="
            firewall-cmd --zone=public --list-rich-rules 2>/dev/null | grep '127.0.0.0/8' || echo "Not found"
            echo "=== IPv6 Loopback Rules ==="
            firewall-cmd --zone=public --list-rich-rules 2>/dev/null | grep '::1' || echo "Not found"
            echo "=== Trusted Zone ==="
            firewall-cmd --zone=trusted --list-all 2>/dev/null || echo "Trusted zone not configured"
          register: loopback_verify
          changed_when: false

        - name: Display loopback configuration status
          debug:
            msg: "{{ loopback_verify.stdout }}"

  # =========================
  # User Hardening
  # =========================
    - name: Check current user shells
      command: grep -E "^(sync|shutdown|halt):" /etc/passwd
      register: user_shells
      changed_when: false
      ignore_errors: yes

    - name: Lock system users shells
      tags: user_hardening
      user:
        name: "{{ item }}"
        shell: /sbin/nologin
      loop:
        - sync
        - shutdown
        - halt
      when: "'/sbin/nologin' not in user_shells.stdout"
      ignore_errors: yes

  # =========================
  # Limits & Profile
  # =========================
    - name: Configure system-wide limits
      tags: limits_hardening
      block:
        - name: Check current limits
          shell: |
            grep -E "^(\\*|root).*(nofile|nproc|core)" /etc/security/limits.conf || echo "no limits"
          args:
            warn: false
          register: limits_current
          changed_when: false
          ignore_errors: yes

        - name: Set limits in /etc/security/limits.conf
          copy:
            dest: /etc/security/limits.conf
            content: |
              *               soft    nofile          1000000
              *               hard    nofile          1000000
              root            soft    nofile          1000000
              root            hard    nofile          1000000
              root            soft    nproc           10240
              *               hard    core            0
              *               soft    core            0
            owner: root
            group: root
            mode: '0644'
          when: "'1000000' not in limits_current.stdout"

        - name: Check current profile umask
          shell: |
            grep "umask" /etc/profile || echo "no umask"
          args:
            warn: false
          register: profile_current
          changed_when: false
          ignore_errors: yes

        - name: Set umask and system info in profile
          blockinfile:
            path: /etc/profile
            block: |
              umask 0027
              HOSTNAME=$(hostname)
              USERNAME=$(whoami)
              UPTIME=$(uptime)
              KERNEL=$(uname -r)
              SIZE=$(df -h / | awk 'NR==2 {print $2}')
              USAGE=$(df -h / | awk 'NR==2 {print $5}')
              echo "**********************************************************************"
              echo "hostname: $HOSTNAME"
              echo "USERNAME: $USERNAME"
              echo "UPTIME: $UPTIME"
              echo "KERNEL: $KERNEL"
              echo "HD Size: $SIZE"
              echo "HD Usage: $USAGE"
              echo "**********************************************************************"
            marker: "# {mark} ANSIBLE MANAGED BLOCK - SYSTEM INFO"
          when: "'umask 0027' not in profile_current.stdout"

  # =========================
  # GRUB Bootloader Hardening
  # =========================
    - name: Configure GRUB audit_backlog_limit
      tags: grub_hardening
      block:
        - name: Backup GRUB configuration
          copy:
            src: /etc/default/grub
            dest: "/etc/default/grub.bak_{{ lookup('pipe','date +%F_%H%M%S') }}"
            remote_src: yes
          ignore_errors: yes

        - name: Check current GRUB_CMDLINE_LINUX
          shell: grep -E '^GRUB_CMDLINE_LINUX=' /etc/default/grub || echo "GRUB_CMDLINE_LINUX=\"\""
          register: grub_cmdline_current
          ignore_errors: yes

        - name: Display current GRUB command line
          debug:
            msg: "Current GRUB_CMDLINE_LINUX: {{ grub_cmdline_current.stdout }}"

        - name: Add audit_backlog_limit to GRUB configuration
          replace:
            path: /etc/default/grub
            regexp: '^(GRUB_CMDLINE_LINUX=")(.*)(")$'
            replace: '\1\2 audit_backlog_limit=8192\3'
            backup: yes
          when: "'audit_backlog_limit=8192' not in grub_cmdline_current.stdout"
          ignore_errors: yes

        - name: Ensure audit=1 is set in kernel boot parameters
          shell: grubby --info=ALL 2>/dev/null | grep -q '\baudit=1\b' && echo "present" || echo "missing"
          register: audit_grub_check
          changed_when: false
          ignore_errors: yes

        - name: Add audit=1 if not present
          command: |
            grubby --update-kernel=ALL --args="audit=1"
          when: audit_grub_check.stdout == "missing"
          register: add_audit_param
          ignore_errors: yes

        - name: Rebuild GRUB configuration
          shell: |
            if command -v grub2-mkconfig >/dev/null 2>&1; then
              grub2-mkconfig -o /boot/grub2/grub.cfg
            elif command -v grub-mkconfig >/dev/null 2>&1; then
              grub-mkconfig -o /boot/grub/grub.cfg
            else
              echo "GRUB mkconfig command not found"
              exit 1
            fi
          args:
            warn: false
          when: "'audit_backlog_limit=8192' not in grub_cmdline_current.stdout or audit_grub_check.stdout == 'missing'"
          ignore_errors: yes

        - name: Display GRUB configuration status
          debug:
            msg: |
              Audit backlog parameter: {{ grub_cmdline_current.stdout }}
              Audit boot parameter: {{ audit_grub_check.stdout }}
          ignore_errors: yes

  # =========================
  # Filesystem Mount Options Hardening
  # =========================
    - name: Harden filesystem mount options
      tags: fstab_hardening
      block:
        - name: Backup fstab file
          copy:
            src: /etc/fstab
            dest: "/etc/fstab.bak_{{ lookup('pipe','date +%F_%H%M%S') }}"
            remote_src: yes
          ignore_errors: yes

        - name: Check current fstab entries
          command: cat /etc/fstab
          register: fstab_current
          changed_when: false
          ignore_errors: yes

        # استفاده از regex عمومی‌تر برای تمام device types
        - name: Harden /home partition
          replace:
            path: /etc/fstab
            regexp: '^(\S+\s+/home\s+\S+\s+)defaults(\s+[0-9]\s+[0-9])$'
            replace: '\1rw,nodev,nosuid\2'
            backup: yes
          when: "'/home' in fstab_current.stdout"
          ignore_errors: yes

        - name: Harden /tmp partition
          replace:
            path: /etc/fstab
            regexp: '^(\S+\s+/tmp\s+\S+\s+)defaults(\s+[0-9]\s+[0-9])$'
            replace: '\1rw,noexec,nodev,nosuid\2'
            backup: yes
          when: "'/tmp' in fstab_current.stdout"
          ignore_errors: yes

        - name: Harden /var partition
          replace:
            path: /etc/fstab
            regexp: '^(\S+\s+/var\s+\S+\s+)defaults(\s+[0-9]\s+[0-9])$'
            replace: '\1rw,nodev,nosuid\2'
            backup: yes
          when: "'/var' in fstab_current.stdout"
          ignore_errors: yes

        - name: Harden /var/log/audit partition
          replace:
            path: /etc/fstab
            regexp: '^(\S+\s+/var/log/audit\s+\S+\s+)defaults(\s+[0-9]\s+[0-9])$'
            replace: '\1rw,noexec,nodev,nosuid\2'
            backup: yes
          when: "'/var/log/audit' in fstab_current.stdout"
          ignore_errors: yes

        - name: Harden /var/log partition
          replace:
            path: /etc/fstab
            regexp: '^(\S+\s+/var/log\s+\S+\s+)defaults(\s+[0-9]\s+[0-9])$'
            replace: '\1rw,noexec,nodev,nosuid\2'
            backup: yes
          when: "'/var/log' in fstab_current.stdout"
          ignore_errors: yes

        - name: Harden /var/tmp partition
          replace:
            path: /etc/fstab
            regexp: '^(\S+\s+/var/tmp\s+\S+\s+)defaults(\s+[0-9]\s+[0-9])$'
            replace: '\1rw,noexec,nodev,nosuid\2'
            backup: yes
          when: "'/var/tmp' in fstab_current.stdout"
          ignore_errors: yes

        - name: Verify fstab changes were applied
          command: grep -E '^\S+\s+/(home|tmp|var|var/log/audit|var/log|var/tmp)\s+' /etc/fstab
          register: fstab_verify
          changed_when: false
          ignore_errors: yes

        - name: Display fstab after changes
          debug:
            var: fstab_verify.stdout

        - name: Remount partitions with new options
          mount:
            path: "{{ item }}"
            src: "{{ item | mount_info | default(omit) }}"
            fstype: "{{ item | mount_info('fstype') | default(omit) }}"
            opts: "{{ item | mount_info('opts') | default(omit) }}"
            state: remounted
          loop:
            - /home
            - /tmp
            - /var
            - /var/log
            - /var/log/audit
            - /var/tmp
          ignore_errors: yes

  handlers:
    - name: Restart SSH
      service:
        name: sshd
        state: restarted

    - name: Restart auditd
      service:
        name: auditd
        state: restarted

    - name: Reload firewall
      command: firewall-cmd --reload
      ignore_errors: yes
